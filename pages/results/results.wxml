<view class="container">
  <!-- Loading State -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">ç»“æœæ­£åœ¨è®¡ç®—ä¸­...</text>
    <text class="loading-subtext">è¯·ç¨å€™ï¼ˆå·²ç­‰å¾… {{pollAttempts}} æ¬¡ï¼‰</text>
  </view>

  <!-- Error State -->
  <view wx:if="{{!isLoading && error}}" class="error-container">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="back-button" bindtap="onBackTap">è¿”å›</button>
  </view>

  <!-- Results Display -->
  <view wx:if="{{!isLoading && resultDataList.length > 0}}" class="results-wrapper">
    <view class="header">
      <text class="title">åˆ†æç»“æœ</text>
      <text class="sequence-info" wx:if="{{resultDataList.length > 1}}">åºåˆ— {{currentResultData.index + 1}} / {{resultDataList.length}}</text>
    </view>

    <!-- Classification Results -->
    <view class="section" wx:if="{{currentResultData.data.classification}}">
      <view class="section-title">åˆ†ç±»ç»“æœ</view>
      <view class="hierarchy-tree">
        <!-- Nucleotide Groups with their Modifications -->
        <view class="nucleotide-group" wx:for="{{classificationTree.children}}" wx:key="nucType">
          <!-- Nucleotide Header -->
          <view class="tree-node nucleotide-node {{item.isPredicted ? 'predicted' : ''}}" data-nuc="{{item.nucType}}">
            <view class="node-indicator"></view>
            <text class="node-text">{{item.name}}</text>
          </view>

          <!-- Modifications under this Nucleotide -->
          <view class="modifications-list">
            <view class="tree-node modification-node {{mod.isPredicted ? 'predicted' : ''}}"
                  wx:for="{{item.children}}"
                  wx:key="name"
                  wx:for-item="mod">
              <view class="node-connector"></view>
              <view class="node-indicator"></view>
              <text class="node-text">{{mod.name}}</text>
              <text class="node-status">{{mod.isPredicted ? 'âœ“' : ''}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Attention Results -->
    <view class="section" wx:if="{{currentResultData.data.attention}}">
      <view class="section-title">æ³¨æ„åŠ›æƒé‡</view>

      <!-- æ— ä¿®é¥°æ£€æµ‹æç¤º -->
      <view class="no-data" wx:if="{{modificationTypeOptions.length === 0}}">
        <text>æœªæ£€æµ‹åˆ°ä¿®é¥°ï¼Œæ— æ³•æ˜¾ç¤ºæ³¨æ„åŠ›æƒé‡</text>
      </view>

      <view wx:else>
        <!-- æ§åˆ¶åŒº -->
        <view class="attention-controls">
          <!-- ä¿®é¥°ç±»å‹é€‰æ‹© -->
          <view class="control-row">
            <text class="control-label">é€‰æ‹©ä¿®é¥°ç±»å‹:</text>
            <picker class="modification-picker" mode="selector" range="{{modificationTypeOptions}}"
                    range-key="label" value="{{selectedModificationIndex}}" bindchange="onModificationTypeChange">
              <view class="picker-display">
                {{modificationTypeOptions[selectedModificationIndex] ? modificationTypeOptions[selectedModificationIndex].label : 'è¯·é€‰æ‹©'}}
              </view>
            </picker>
          </view>

          <!-- TopX æ§åˆ¶ -->
          <view class="control-row">
            <text class="control-label">æ˜¾ç¤º Top </text>
            <input class="topx-input" type="number" value="{{topX}}" bindinput="onTopXInput" min="1" max="100" />
            <text class="control-label"> ä¸ªä½ç‚¹</text>
          </view>

          <!-- å¯¼èˆªæŒ‰é’® -->
          <view class="nav-buttons-container">
            <button class="nav-btn" bindtap="onPrevSite" disabled="{{currentAttentionIndex === 0}}">
              â† ä¸Šä¸€ä¸ª
            </button>
            <text class="nav-info">
              {{displayWeights.length > 0 ? currentAttentionIndex + 1 : 0}} / {{displayWeights.length}}
            </text>
            <button class="nav-btn" bindtap="onNextSite"
                    disabled="{{currentAttentionIndex >= displayWeights.length - 1}}">
              ä¸‹ä¸€ä¸ª â†’
            </button>
          </view>
        </view>

        <!-- æ— æ•°æ®æç¤º -->
        <view class="no-data" wx:if="{{displayWeights.length === 0}}">
          <text>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— åŒ¹é…ä½ç‚¹</text>
        </view>

        <!-- åºåˆ—è§†å›¾ -->
        <view wx:else class="attention-viz-container" id="attention-viz-section">
          <!-- å½“å‰é«˜äº®ä¿¡æ¯ -->
          <view class="highlight-info" wx:if="{{currentHighlight}}">
            <text class="highlight-label">å½“å‰é«˜äº®:</text>
            <text class="highlight-value">
              {{currentHighlight.type}} (åˆ†æ•°: {{currentHighlight.displayScore}}},
              ä½ç½®: {{currentHighlight.index}})
            </text>
          </view>

          <!-- åºåˆ—è§†å£ -->
          <scroll-view class="sequence-viewport" scroll-x="true" scroll-into-view="{{scrollToId}}" scroll-with-animation="{{true}}" id="sequence-viewport">
            <view class="viewport-content">
              <view id="block-{{item.index}}" class="sequence-block {{item.isHighlighted ? 'highlighted' : ''}}"
                    wx:for="{{viewportElements}}">
                <view wx:if="{{item.isHighlighted}}" class="annotation-label">
                  {{currentHighlight.type}} ({{currentHighlight.displayScore}})
                </view>
                <view class="base-block" style="background-color: {{item.bgColor}};">
                  {{item.base}}
                </view>
              </view>
            </view>
          </scroll-view>

          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <view class="attention-stats">
            <view class="stat-item">
              <text class="stat-label">åºåˆ—é•¿åº¦:</text>
              <text class="stat-value">{{sequence.length}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">æ€»æƒé‡æ•°æ®:</text>
              <text class="stat-value">{{currentResultData.data.attention.weights.length}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">å½“å‰æ˜¾ç¤º:</text>
              <text class="stat-value">{{displayWeights.length}}</text>
            </view>
          </view>

          <!-- ä½ç‚¹åˆ—è¡¨ -->
          <view class="sites-list">
            <view class="site-list-header">å½“å‰æ˜¾ç¤ºçš„ä¿®é¥°ä½ç‚¹åˆ—è¡¨:</view>
            <view class="site-list-item" wx:for="{{displayWeights}}" wx:for-index="idx">
              <text class="site-rank">{{idx + 1}}.</text>
              <text class="site-type">{{item.type}}</text>
              <text class="site-position">ä½ç½®: {{item.index}}</text>
              <text class="site-score">åˆ†æ•°: {{item.displayScore}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- GCN Results -->
    <view class="section" wx:if="{{currentResultData.data.gcn}}">
      <view class="section-title">GCN å›¾ç»“æ„</view>
      <view class="gcn-stats">
        <view class="stat-item">
          <text class="stat-label">èŠ‚ç‚¹æ•°:</text>
          <text class="stat-value">{{currentResultData.data.gcn.nodes.length}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">è¾¹æ•°:</text>
          <text class="stat-value">{{currentResultData.data.gcn.edges.length}}</text>
        </view>
      </view>

      <!-- ECharts å›¾ç»“æ„å¯è§†åŒ– -->
      <view class="gcn-echarts-container">
        <ec-canvas id="gcn-chart" canvas-id="gcn-canvas" ec="{{gcnEc}}"></ec-canvas>
      </view>
      <!-- <view class="gcn-hint">
        <text>ğŸ’¡ ä½¿ç”¨ ECharts ç»˜åˆ¶ï¼Œæ”¯æŒæ‹–åŠ¨å’Œç¼©æ”¾</text>
      </view> -->
    </view>

    <!-- Back Button -->
    <!-- <view class="button-container">
      <button class="back-button" bindtap="onBackTap">è¿”å›</button>
    </view> -->
  </view>

  <!-- æ ‡ç­¾é¡µåˆ‡æ¢åŒºåŸŸ - åº•éƒ¨å›ºå®š -->
  <view class="tab-bar-container" wx:if="{{resultDataList.length > 1}}">
    <scroll-view class="tab-scroll" scroll-x="true" scroll-with-animation="{{true}}">
      <view class="tab-list">
        <view
          class="tab-item {{currentTabIndex === index ? 'active' : ''}}"
          wx:for="{{resultDataList}}"
          wx:key="index"
          bindtap="onTabTap"
          data-index="{{index}}">
          <text class="tab-text">åºåˆ— {{item.index + 1}}</text>
          <view class="tab-indicator" wx:if="{{currentTabIndex === index}}"></view>
        </view>
      </view>
    </scroll-view>
  </view>
</view>
